<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Grid 10x7 - Auto Save</title>
    <style>
        /* ... (Keep all your original CSS here) ... */
        
        /* Add a style for the Save Button */
        #gh-save-btn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            background: #00FF00;
            color: #000;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            font-family: sans-serif;
            box-shadow: 0 0 10px rgba(0,255,0,0.3);
        }
    </style>
</head>
<body>

    <div class="grid-container" id="grid"></div>
    <div id="gh-save-btn" onclick="saveToGithub()">SAVE</div>

    <script>
        // --- 1. CONFIGURATION (Edit these two!) ---
        const GITHUB_USER = 'YOUR_USERNAME'; 
        const GITHUB_REPO = 'YOUR_REPO_NAME';
        const FILE_PATH = 'index.html';

        // --- 2. DATA LOADING ---
        // These lines will be automatically updated by the save function
        let savedState = JSON.parse(localStorage.getItem('gridState_10x7')) || [];
        let savedImages = JSON.parse(localStorage.getItem('gridImages_10x7')) || [];

        // ... (Keep all your original Sound Engine, Resizer, and Init Logic) ...
        // Change maxSize to 100 as we discussed
        const maxSize = 100; 

        // --- 3. THE GITHUB SAVE ENGINE ---
        async function saveToGithub() {
            let token = localStorage.getItem('gh_token');
            
            if (!token) {
                token = prompt("Enter your GitHub Token (It will be saved in your browser only):");
                if (token) localStorage.setItem('gh_token', token);
                else return;
            }

            const saveBtn = document.getElementById('gh-save-btn');
            saveBtn.innerText = "WAIT...";
            saveBtn.style.background = "yellow";

            // Prepare the "Inception" HTML
            // This captures the current state of the page
            let currentHTML = document.documentElement.outerHTML;
            
            // This replaces the variable definitions with the actual current data
            const imgDataLine = `let savedImages = ${JSON.stringify(savedImages)};`;
            const stateDataLine = `let savedState = ${JSON.stringify(savedState)};`;
            
            let updatedHTML = currentHTML
                .replace(/let savedImages = .*?;/, imgDataLine)
                .replace(/let savedState = .*?;/, stateDataLine);

            try {
                // Get the SHA of the current file so we can overwrite it
                const getFile = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FILE_PATH}`);
                const fileData = await getFile.json();

                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'Permanent Grid Update',
                        content: btoa(unescape(encodeURIComponent("<!DOCTYPE html>\n" + updatedHTML))),
                        sha: fileData.sha
                    })
                });

                if (response.ok) {
                    alert("Saved! GitHub Pages will update in about 60 seconds.");
                    saveBtn.innerText = "DONE";
                    saveBtn.style.background = "#00FF00";
                } else {
                    const err = await response.json();
                    alert("Error: " + err.message);
                    if (response.status === 401) localStorage.removeItem('gh_token');
                    saveBtn.innerText = "FAIL";
                }
            } catch (error) {
                alert("Connection failed.");
                saveBtn.innerText = "SAVE";
            }
        }
        
        // ... (Keep all your existing grid creation and event listener code) ...

    </script>
</body>
</html>
