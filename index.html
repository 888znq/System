<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#000000">
    
    <title>Smart Grid 10x7</title>
    <style>
        /* 1. RESET & LOCK */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body, html {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000000; 
            overflow: hidden; 
            overscroll-behavior: none; 
            user-select: none;
        }

        /* 2. LAYOUT */
        .grid-container {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(7, 3fr 2fr);
            padding: 2vmin; 
            gap: 1.5vmin;
        }

        /* 3. IMAGE BOX */
        .image-box {
            position: relative;
            border: 2px solid #FF0000;
            background-color: #111; 
            border-radius: 4px;
            width: 100%;
            height: 100%;
            cursor: pointer;
            overflow: hidden;
            
            /* Image Positioning */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            
            transition: border-color 0.1s;
        }

        /* THE PLUS SIGN (+) */
        .image-box::after {
            content: "+";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #444; 
            font-size: 24px;
            font-family: sans-serif;
            font-weight: bold;
            pointer-events: none; 
        }

        /* Hide Plus when image exists */
        .image-box.has-image::after { display: none; }

        /* ACTIVE STATE (Green Border) */
        .image-box.active { border-color: #00FF00; }

        /* SELECTED STATE (Yellow Border - For Swap/Delete) */
        .image-box.selected-edit {
            border-color: #FFFF00 !important; /* Force Yellow */
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 255, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0); }
        }

        /* Hidden File Input */
        .file-input { display: none; }

        /* 4. TOGGLE BUTTONS */
        .toggle-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .circle-btn {
            height: 80%; 
            aspect-ratio: 1 / 1; 
            border-radius: 50%;
            background-color: #FF0000;
            border: 2px solid #000000; 
            cursor: pointer;
        }

        .circle-btn.active { background-color: #00FF00; }

    </style>
</head>
<body>

    <div class="grid-container" id="grid"></div>

    <script>
        const grid = document.getElementById('grid');
        const cols = 10;
        const units = 7;
        
        // --- SOUND ENGINE ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioContext.state === 'suspended') audioContext.resume();
            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);
            const now = audioContext.currentTime;
            
            if (type === 'on') { 
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
            } else if (type === 'off') { 
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            } else if (type === 'select') { // Yellow Select
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
            } else if (type === 'delete') { // Delete
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.2);
            } else if (type === 'swap') { // Swap
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(400, now + 0.1);
            }

            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.start();
            osc.stop(now + 0.2);
        }

        // --- IMAGE RESIZER ---
        function resizeImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxSize = 150; 
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- INIT STATE ---
        let savedState = JSON.parse(localStorage.getItem('gridState_10x7')) || [];
        let savedImages = JSON.parse(localStorage.getItem('gridImages_10x7')) || [];

        // --- EDIT MODE VARIABLES ---
        let selectedIndex = null; // Stores the index of the box currently "Long Pressed"
        let longPressTimer = null;
        let isLongPress = false;

        let itemIndex = 0; 
        let allBoxes = []; // Store box references to update UI easier

        for (let u = 0; u < units; u++) {
            let currentBoxes = [];

            // 1. IMAGE BOXES
            for (let c = 0; c < cols; c++) {
                const currentIndex = itemIndex + c;

                const box = document.createElement('div');
                box.classList.add('image-box');
                
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.classList.add('file-input');

                // LOAD SAVED IMAGE
                if (savedImages[currentIndex]) {
                    box.style.backgroundImage = `url(${savedImages[currentIndex]})`;
                    box.classList.add('has-image');
                }
                // LOAD SAVED STATUS
                if (savedState[currentIndex] === true) box.classList.add('active');

                // --- INTERACTION LOGIC (Touch & Mouse) ---
                
                const startHandler = (e) => {
                    isLongPress = false;
                    longPressTimer = setTimeout(() => {
                        // LONG PRESS DETECTED -> ENTER EDIT MODE
                        isLongPress = true;
                        handleSelection(currentIndex);
                        
                        // Prevent context menu on mobile
                        if(e.cancelable && e.preventDefault) e.preventDefault(); 
                    }, 500); // 500ms hold time
                };

                const endHandler = (e) => {
                    clearTimeout(longPressTimer);
                };

                const clickHandler = (e) => {
                    if (isLongPress) return; // Ignore click if we just triggered long press

                    // IF A BOX IS ALREADY SELECTED (EDIT MODE)
                    if (selectedIndex !== null) {
                        if (selectedIndex === currentIndex) {
                            // TAP SAME BOX -> DELETE
                            deleteImage(currentIndex);
                        } else {
                            // TAP DIFFERENT BOX -> SWAP
                            swapImages(selectedIndex, currentIndex);
                        }
                        return; // Stop here, don't open file manager
                    }

                    // NORMAL CLICK -> UPLOAD
                    fileInput.click();
                };

                // Add Listeners
                box.addEventListener('mousedown', startHandler);
                box.addEventListener('touchstart', startHandler, {passive: false});
                
                box.addEventListener('mouseup', endHandler);
                box.addEventListener('touchend', endHandler);
                
                box.onclick = clickHandler;

                // FILE UPLOAD HANDLER
                fileInput.onchange = function(e) {
                    if (this.files && this.files[0]) {
                        resizeImage(this.files[0], function(base64Image) {
                            savedImages[currentIndex] = base64Image;
                            updateBoxUI(currentIndex);
                            saveData();
                        });
                    }
                    this.value = ''; // Reset input to allow re-uploading same file
                };

                box.appendChild(fileInput);
                grid.appendChild(box);
                
                currentBoxes.push(box);
                allBoxes.push(box); // Track all boxes
            }

            // 2. TOGGLE BUTTONS
            for (let c = 0; c < cols; c++) {
                const cell = document.createElement('div');
                cell.classList.add('toggle-cell');
                const btn = document.createElement('div');
                btn.classList.add('circle-btn');
                const currentId = itemIndex; 
                const linkedBox = currentBoxes[c]; 

                if (savedState[currentId] === true) btn.classList.add('active');

                btn.onclick = function() {
                    const isCurrentlyActive = btn.classList.contains('active');
                    const newState = !isCurrentlyActive; 
                    if (newState) {
                        btn.classList.add('active');
                        linkedBox.classList.add('active');
                        playSound('on');
                    } else {
                        btn.classList.remove('active');
                        linkedBox.classList.remove('active');
                        playSound('off');
                    }
                    savedState[currentId] = newState;
                    localStorage.setItem('gridState_10x7', JSON.stringify(savedState));
                };

                cell.appendChild(btn);
                grid.appendChild(cell);
                itemIndex++; 
            }
        }

        // --- HELPER FUNCTIONS ---

        function handleSelection(index) {
            // Select Logic
            if (selectedIndex !== null) {
                // Deselect previous
                allBoxes[selectedIndex].classList.remove('selected-edit');
            }
            
            selectedIndex = index;
            allBoxes[index].classList.add('selected-edit');
            playSound('select');
            
            // Auto deselect after 5 seconds if idle
            setTimeout(() => {
                if (selectedIndex === index) clearSelection();
            }, 5000);
        }

        function clearSelection() {
            if (selectedIndex !== null) {
                allBoxes[selectedIndex].classList.remove('selected-edit');
                selectedIndex = null;
            }
        }

        function deleteImage(index) {
            savedImages[index] = null; // Clear data
            updateBoxUI(index);
            saveData();
            playSound('delete');
            clearSelection();
        }

        function swapImages(fromIndex, toIndex) {
            // Swap Data
            const temp = savedImages[fromIndex];
            savedImages[fromIndex] = savedImages[toIndex];
            savedImages[toIndex] = temp;

            // Update UI
            updateBoxUI(fromIndex);
            updateBoxUI(toIndex);
            
            saveData();
            playSound('swap');
            clearSelection();
        }

        function updateBoxUI(index) {
            const box = allBoxes[index];
            const imgData = savedImages[index];
            
            if (imgData) {
                box.style.backgroundImage = `url(${imgData})`;
                box.classList.add('has-image');
            } else {
                box.style.backgroundImage = '';
                box.classList.remove('has-image');
            }
        }

        function saveData() {
            try {
                localStorage.setItem('gridImages_10x7', JSON.stringify(savedImages));
            } catch (err) {
                alert("Storage full! Delete some images.");
            }
        }

    </script>
</body>
</html>